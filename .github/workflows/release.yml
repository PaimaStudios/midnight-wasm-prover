name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - run: apt update
    - run: apt install clang -y

    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly-2025-10-01
        components: rust-src

    - name: Install just
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        sudo chmod +x /usr/local/bin/just

    - uses: jetli/wasm-pack-action@v0.4.0

    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build WASM package
      run: just build
      
    - name: Create release archive
      run: |
        cd pkg
        PACKAGE_FILE=$(npm pack)
        mv "$PACKAGE_FILE" ../
        echo "PACKAGE_FILE=$PACKAGE_FILE" >> $GITHUB_ENV
        cd ..
        
    - name: Create GitHub Release
      if: ${{ !env.ACT }}
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.PACKAGE_FILE }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
